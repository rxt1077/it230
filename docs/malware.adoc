= Malware (WIP)

== What is malware?

Malware is a portmanteau of the words _malicious_ and _software_.
The term is used to describe many different types of _intentionally malicious_ programs.
Malware damages or exploits computer systems.
It often spies on, spams, or otherwise damages target or host machines.

== Malware Targets

[.float-group]
--

.Malware Distribution by OS (Q1 2020)
[gnuplot, malware, width=500, float=left]
....
set key off
set ylabel "Percentage of Malware Detections"
set boxwidth 0.5
set style fill solid
plot "-" using 1:3:xtic(2) lt rgb "#ff2c001e" with boxes
0 Windows 83.45
1 Browser 11.09
2 Android 3.24
3 Other   1.91
....

The most popular target for malware is the Windows OS by quite a large margin.
This is due largely to its popularity as a desktop operating system.
The second largest target is web browsers, which afford malware a unique cross-platform reach.
The third largest target is the Android mobile operating system, which while technically Linux runs mostly on mobile phones.
Both Linux and Mac do not receive as much malware attention.
While this may be partially due to the open-source nature of Linux and the BSD kernel used by Macs, it is also partially due to the lack of popularity of each of these operating systems.
Malware is often widely distributed, meaning it can target only the most popular/possibly weakest links and still be successful.

--

.Zero Days
****
Modern operating systems employ layers of security to ensure that programs do not have access to sensitive information or applications.
This typically means that for malware to be effective, it needs to elevate its privileges.
The most effective malware can perform privilege escalation without requiring user interaction.
To do this malware may rely on new/undocumented exploits or vulnerabilities.
These new exploits that have been disclosed for "zero days" are hence are referred to as _zero days_.
Zero days are incredibly powerful and may be hoarded by APTs/criminal groups or sold for millions of dollars on the Dark Web. 
****

== Types of Malware

The definition of malware is so broad and new malware is being created daily.
This can make it difficult to classify malware.
As we go through some basic types, please keep in mind that there is significant overlap.
For example, you may encounter ransomeware distributed as a virus _or_ ransomeware distributed as a trojan.
The fact that it is ransomeware does not preclude it from being some other type of malware as well. 

=== Worms, Viruses, and Trojans

Worms are self-propagating programs that spread without user interaction.
Their code is typically stored within an independent object, such as a hidden executable file.
Worms often do not severely damage their host, as they are concerned with rapid, exponential spreading.

.Stuxnet
====
Stuxnet was a 2010 worm that specifically targeted Iranian nuclear facilities.
The worm used an unprecedented four zero-day attacks and was designed to spread via USB flash drives and Remote Procedure Calls (RPCs).
In this way it didn't just rely on networks to propagate.
Ultimately Stuxnet's payload targeted the code used to program PLC devices that control motors and make them spin too fast, destroying the centrifuges.
Stuxnet also employed an impressive rootkit to cover its tracks.
Given the level of sophistication Stuxnet is believed to have been developed by the US and Israel.
====

Viruses typically require user interaction, such as copying and infected file from one machine to another, and store their code inside another file on a machine.
An executable file may be infected by having the virus code added a separate page that executes before the standard program code.
Viruses can be quite damaging to the host as they may take significant resources to spread locally.
The term virus is also an unfortunately overloaded one.
Due to it's popularity it is often used by some lower-skill threat actors to refer to many different types of malware.

.Concept Virus
====
The Concept virus was the first example of a Microsoft Word macro virus.
The virus hid itself inside Microsoft Word files and used Word's embedded macro language to perform its replication tasks.
Viruses were later created for Excel and other programs that had sufficiently sophisticated yet ultimately insecure internal scripting languages.
====

A trojan is a form of malware that disguises itself as legitimate software.
It does not have to rely on a software exploit as much as it exploits users into installing, running, or giving extra privileges to the malicious code.
Trojans are the most popular kind of malware as they can be used as an attack vector for many other payloads.
The name comes from Greek mythology, where a Trojan horse was disguised as a gift and given to a besieged town.
Within the large horse were secret troops who came out in the middle of the night and opened the town gates.

.Emotet
====
Emotet is a banking trojan from 2014 that spread through emails.
It made use of malicious links or macro-enabled documents to make the user download its code.
Emotet has been one of the most costly and destructive pieces of malware currently averaging about one million in incident remediation.
It continues to be adapted to avoid detection and make use of even more sophisticated malware.
====

=== Ransomware

image::wannacry.png[width=400, float=right]

Ransomware is a type of malware that encrypts files and demands a ransom to unencrypt them.
Modern ransomware uses symmetric encryption to the files quickly and then encrypts the symmetric key asymmetrically using a hard-coded public key for which the threat actor has the corresponding private key.
When the ransom is paid, typically via cryptocurrency, the threat actor can decrypt the symmetric key using their private key and the user can use the symmetric key to decrypt the files.

Ransomware is considered a data breach in the data is often exfiltrated as well.
It is also worth noting that when the ransom is paid, there is no guarantee that the threat actor will actually begin the decryption process.
Typical targets of ransomware include corporate infrastructure and health care systems although ransomware may also be spread indeterminately.
The payout of ransoms can be a large money-making enterprise so many APTs or criminal groups may employ its use.
Ransomware is considered the biggest threat to cyber stability today.

=== Spyware

Malware specifically designed for espionage/data theft is known as spyware.
Like ransomware, spyware can also have a monitary payoff for the threat actor.
Actors may use extortion to demand payment or the data will be _leaked_.
This typically means either sold on the dark web or publically posted.
Once again, given the possibility of monitary gain, spyware is often associated with criminal groups.
APTs may use spyware as well to obtain secrets of national importance.

Customer data, trade secrets, proprietary data, and government secrets are all targets of spyware.
Even outside of governments systems, in the corporate setting, spyware is still a major threat. 

.Fileless Malware
****
[svgbob, fileless, svg, align="center"]
....
                                           "If machine is restarted, payload is re-run"
                                         +---------------------------------------------+
                                         |                                             |
                                         |            .------------------------.       |
                                         |            | Scripts and Executables|       |
                                         |            |    stored remotely     |       |
                                         |            '------------+-----------'       |
                                         |                         |                   |
                 Website loads           |                         V                   |
   .--------.  JavaScript exploit        V                   .------------.     +------+-------+
   |\      /|        .----.           .----.                /  Runtime   /      |"Auto-start"  |
   | '----' | -----> | JS | --------> | PS | ------------> / Environment/ ----> |registry entry|
   '--------'        '----'           '----'              '------------'        +--------------+
User clicks a link          Shellcode runs Powershell    Payload downloaded
  in spam email             one-liner to download and    and run in memory
                              run payload in memory
....

Malware is often detected by scanning storage for files that match a particular hash or by looking in files to see if they contain patterns.
Both of these detection techniques rely on the malware being stored in a file.
Fileless malware attempts to avoid detection by leaving no footprint in the filesystem.
This type of malware uses legitimate processes to load itself into memory, often with a registry key created to reload every time the machine is restarted.
This creates a persitent, hard-to-detect type of malware that is often used by sophisticated threat actors such as APTs and criminal groups.
****

////
=== Cryptojacking

=== Rootkit

=== Botnet

=== RAT

=== Adware / Potentially Unwanted Programs (PUP)

== Indicators of Compromise (IoC)

== Cyber Killchain

=== Recon

=== Weaponization

=== Delivery

=== Exploitation

=== Installation

=== Command and Control (C2C)

=== Exfiltration / Actions & Objectives

== Delivery of Malware

=== Phishing

=== SPAM

=== Dumpster Diving

=== Shoulder Surfing
////

== Review

=== Labs

.Malware Analysis
[lab]
--

The website https://any.run[Any Run] offers free interactive malware analysis.
We will be using this site to avoid the complications of running malware in a VM.

Start by visiting https://any.run[Any Run] and registering for an account with your NJIT email address.
Once you have activated your account via email, follow the tutorial to learn how to analyze threats.
Use the demo-sample task provided by Any Run.
Follow the prompts and watch how the process tree changes.
Feel free to take your time, even after the time expires you will still be able to look at the running processes and analyze HTTP Requests, Connections, DNS Requests, and Threats.

For this lab we are going to look at an example of https://www.malwarebytes.com/emotet[Emotet], a banking Trojan discovered in 2014.
On the left-hand side of the Any Run site, click on _Public tasks_ and search for the md5 sum `0e106000b2ef3603477cb460f2fc1751`.
Choose _one_ of the examples (there are three) and look through the screenshots to get an idea of how the malware is run.
It may also help to glance at the network traffic processes.

Run the VM live by clicking _Restart_ in the upper right-hand corner.
Perform the actions necessary to trigger the malware, adding time as needed.
Finally open notepad on the VM, type in your name, and take a unique screenshot.

[IMPORTANT.deliverable]
====
Submit a unique screenshot of your VM
====

Use the Any Run tools to analyze the malware you chose.

[IMPORTANT.deliverable]
====
Answer the following questions in the text box provided:

[qanda]
What does this malware do to ensure that it is always running in the background?::
    {empty}
Why is malware often put inside an archive file instead of being distributed as a simple executable?::
    {empty}
What IP addresses does this malware attempt to connect to?::
    {empty}
Does this malware resolve any DNS addresses? How do you know?::
    {empty}
How could you uniquely identify this file as malware (be specific, like specific enough for a malware scanner to find it)?::
    {empty}
What are IoCs and what are the IoCs for this malware?::
    {empty}

====
--

=== Questions

[qanda]
Why might an APT choose to use fileless malware as opposed to malware that runs from a file on a machine?::
    {empty}
What is an IoC? Give an example.::
    {empty}
What is phishing? What are the five types of phishing? Give an example of each type.::
    {empty}
